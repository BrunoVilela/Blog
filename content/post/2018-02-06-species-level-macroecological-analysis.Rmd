---
title: Macroecological analysis at the species level
author: Bruno Vilela
date: '2018-02-06'
categories:
  - macroecology
tags:
  - letsR
  - Presence Absence Matrix
  - R
  - Rasters
  - Shapefiles
  - subset
  - traits
  - Variables
slug: species-level-macroecological-analysis
---

In the previous post, I have shown how to use `letsR` to analyze species traits at the community level. But, in many cases this type of analysis can lead to spurious patterns ([click here for further discussion on this issue](http://onlinelibrary.wiley.com/doi/10.1111/jbi.12953/full)). An alternative can be analyzing the data at the species-level. In this post, I will show an example on how to make macroecological analysis at the species level using the `letsR` package. As an example we will explore how climate correlates with species extinction risk. 

To start this test we can load our `PresenceAbsence` object that we generated previously  (see the [first](https://rmacroecology.netlify.com/2018/01/23/a-guide-to-transform-species-shapefiles-into-a-presence-absence-matrix-based-on-a-user-defined-grid-system/) and [second](https://rmacroecology.netlify.com/2018/01/24/transfom-a-matrix-of-species-presence-absence-into-a-presenceabsence-object/) posts on how to do it).

*Note: I recommend to use the latest version of the `letsR` package on [GitHub](https://github.com/macroecology/letsR)*
```{r, message = FALSE, warning=FALSE}
library(letsR)
```
```{r}
data("PAM")
```

To make things even more interesting, lets make an iterative map using the leaflet package (if you just want a normal plot use: `plot(PAM)`).
```{r, message = FALSE, warning=FALSE}
library(leaflet)
```

```{r}
r <- PAM$Richness_Raster
values(r)[values(r) == 0] <- NA
pal <- colorNumeric(c('#edf8e9','#c7e9c0','#a1d99b',
                       '#74c476','#31a354','#006d2c'), 
                    values(r), 
                    na.color = "transparent")
h = "https://mts1.google.com/vt/lyrs=s&hl=en&src=app&x={x}&y={y}&z={z}&s=G"
leaflet() %>% 
    addTiles(urlTemplate = h,
             attribution = 'Google') %>%
  addRasterImage(r, colors = pal, opacity = .6) %>%
  addLegend(pal = pal, values = values(r),
    title = "Species Richness")
```




After we can add environmental variables to the `PresenceAbsence`object (click here for a detailed tutorial on this subject)[https://rmacroecology.netlify.com/2018/01/26/adding-variables-to-a-presenceabsence-object/]). 

```{r}
r <- raster(getData("worldclim", var = "bio", 
             res = 10), 1) / 10
projection(PAM$Richness_Raster) <- projection(r)
PAM_env <- lets.addvar(PAM, r, fun = mean)
```

Next step is to get the average values per species for temperature. The `lets.summarizer` can do this directly on the resulting object of `lets.addvar` function (note that this can only be done if `onlyvar = FALSE`). We only have to indicate the position of the variable in the matrix using the argument `pos`. 

```{r}
pos <- which(colnames(PAM_env) == "bio1_mean")
temp_mean <- lets.summarizer(PAM_env, pos)
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(knitr)
library(dplyr)
library(kableExtra)
```

```{r, eval=FALSE}
temp_mean
```

```{r, echo = FALSE}
kable(temp_mean, "html") %>%
  kable_styling() %>%
  scroll_box(width = "400px", height = "400px")
```


Next we can relate the species mean temperature with any trait. Following our example, we need to take the IUCN extinction risk data. Previous version of the package included functions to do this, but they are no longer supported, but luckily there is a new package called [`rredlist`](https://ropensci.org/tutorials/rredlist_tutorial/) that can do this for us. For now, we can use the example data in the `letsR` package  called `IUCN`.
```{r}
data("IUCN")
```

```{r, eval=FALSE}
IUCN
```

```{r, echo = FALSE}
kable(IUCN, "html") %>%
  kable_styling() %>%
  scroll_box(width = "800px", height = "400px")
```

Finally, we can verify the relationship between temperature and extinction risk.
```{r, message = FALSE, warning=FALSE}
library(ggplot2)
```

```{r}
level_order <- c("DD", "LC",  "EN", "CR") # ordering for the plot
data <- data.frame("Status" = factor(IUCN$Status, levels = level_order),
                   "Temperature" = temp_mean[, 2])
g <- ggplot(data, aes(Status, Temperature))
g + geom_boxplot() + coord_flip()
```

The graph indicate that there is a tendency for threatened Phyllomedusa species to occur in colder regions. Still, further formal statistical analysis could confirm this pattern.

**To cite letsR in publications use:**
*Bruno Vilela and Fabricio Villalobos (2015). letsR: a new R package for data handling and analysis in macroecology. Methods in Ecology and Evolution. DOI: 10.1111/2041-210X.12401*



